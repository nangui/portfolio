---
import BlogLayout from '@layouts/BlogLayout.astro';
import { getCollection, render, type CollectionEntry } from 'astro:content';
import TableOfContents from '@components/blog/TableOfContents.astro';
import ReadingTime from '@components/blog/ReadingTime.astro';
import SocialShare from '@components/blog/SocialShare.astro';
import BlogNavigation from '@components/blog/BlogNavigation.astro';
import TextDistortion from '@components/ui/TextDistortion.astro';
import { readFileSync } from 'fs';
import { join } from 'path';

export async function getStaticPaths() {
  const blogPosts = await getCollection('blog');
  // Helper function to get slug from entry
  // With glob loader, id contains the file path relative to base
  const getSlug = (entry: CollectionEntry<'blog'>) => {
    if (entry.data.slug) return entry.data.slug;
    // Extract filename from id and remove extension
    const filename = entry.id.split('/').pop() || entry.id;
    return filename.replace(/\.(md|mdx)$/, '');
  };
  
  // Sort posts by publication date (newest first)
  const sortedPosts = [...blogPosts].sort((a, b) => {
    return b.data.pubDate.getTime() - a.data.pubDate.getTime();
  });
  
  return sortedPosts.map((post: CollectionEntry<'blog'>, index: number) => {
    const slug = getSlug(post);
    
    // Find previous and next posts
    const previous = index < sortedPosts.length - 1 ? sortedPosts[index + 1] : null;
    const next = index > 0 ? sortedPosts[index - 1] : null;
    
    return {
      params: { slug },
      props: { post, previous, next },
    };
  });
}

interface Props {
  post: CollectionEntry<'blog'>;
  previous?: CollectionEntry<'blog'> | null;
  next?: CollectionEntry<'blog'> | null;
}

const { post, previous, next } = Astro.props;
const { Content } = await render(post);

// Get raw markdown content for reading time calculation
const getSlug = (entry: CollectionEntry<'blog'>) => {
  if (entry.data.slug) return entry.data.slug;
  const filename = entry.id.split('/').pop() || entry.id;
  return filename.replace(/\.(md|mdx)$/, '');
};

let rawContent = '';
try {
  const slug = getSlug(post);
  const filePath = join(process.cwd(), 'src', 'content', 'blog', `${slug}.md`);
  rawContent = readFileSync(filePath, 'utf-8');
  // Remove frontmatter
  rawContent = rawContent.replace(/^---[\s\S]*?---\n/, '');
} catch (error) {
  console.warn('Could not read markdown file for reading time:', error);
  rawContent = '';
}

// Get current URL for sharing
const getSlugForUrl = (entry: CollectionEntry<'blog'>) => {
  if (entry.data.slug) return entry.data.slug;
  const filename = entry.id.split('/').pop() || entry.id;
  return filename.replace(/\.(md|mdx)$/, '');
};
const postSlug = getSlugForUrl(post);
const postUrl = `${Astro.site || 'https://adonainangui.dev'}/blog/${postSlug}`;
---

<BlogLayout 
  title={`${post.data.title} - Blog Adonai Nangui`}
  description={post.data.description}
>
  <article class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 md:py-16">
    <!-- Breadcrumb amélioré -->
    <nav class="mb-8 scroll-animate" aria-label="Breadcrumb">
      <ol class="flex items-center gap-2 text-sm text-secondary">
        <li>
          <a href="/" class="hover:text-accent transition-colors">Accueil</a>
        </li>
        <li class="text-secondary/60">/</li>
        <li>
          <a href="/blog" class="hover:text-accent transition-colors">Blog</a>
        </li>
        <li class="text-secondary/60">/</li>
        <li class="text-primary truncate max-w-[200px] md:max-w-none" aria-current="page">
          {post.data.title}
        </li>
      </ol>
    </nav>

    <header class="mb-12 pb-8 border-b border-border-default scroll-animate">
      <TextDistortion animateOnLoad={true}>
        <h1 class="font-heading font-semibold text-3xl md:text-4xl lg:text-5xl mb-6 text-primary leading-tight">
        {post.data.title}
      </h1>
      </TextDistortion>
      
      <div class="flex flex-col sm:flex-row sm:items-center gap-4 text-sm text-secondary">
        <div class="flex items-center gap-4 flex-wrap">
          <time datetime={post.data.pubDate.toISOString()} class="flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
          {post.data.pubDate.toLocaleDateString('fr-FR', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
          })}
        </time>
          
          {rawContent && <ReadingTime content={rawContent} />}
        </div>
        
        {post.data.tags && post.data.tags.length > 0 && (
          <div class="flex items-center gap-2 flex-wrap">
            <svg class="w-4 h-4 text-secondary/60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
            </svg>
            {post.data.tags.map((tag: string) => (
              <span class="px-3 py-1 bg-secondary/50 border border-border-default rounded-full text-xs hover:bg-secondary transition-colors">
                {tag}
              </span>
            ))}
          </div>
        )}
      </div>
    </header>
    
    <div class="flex gap-12 lg:gap-16">
      <!-- Table of Contents -->
      <aside class="hidden xl:block shrink-0 w-80">
        <TableOfContents />
      </aside>
      
      <!-- Main Content -->
      <div class="flex-1 min-w-0 max-w-4xl">
        <div class="prose prose-invert prose-lg max-w-none text-secondary leading-relaxed scroll-animate">
      <Content />
        </div>
        
        <!-- Social Share -->
        <SocialShare 
          title={post.data.title}
          url={postUrl}
          description={post.data.description}
        />
        
        <!-- Blog Navigation -->
        <BlogNavigation previous={previous} next={next} />
      </div>
    </div>
  </article>
  
  <script>
    import('gsap').then(({ gsap }) => {
      return import('gsap/ScrollTrigger').then(({ default: ScrollTrigger }) => {
        gsap.registerPlugin(ScrollTrigger);
        
        // Animate elements with scroll-animate class
        const animateElements = document.querySelectorAll('.scroll-animate');
        
        animateElements.forEach((element, index) => {
          gsap.fromTo(element,
            {
              opacity: 0,
              y: 30,
            },
            {
              opacity: 1,
              y: 0,
              duration: 0.8,
              ease: 'power2.out',
              delay: index * 0.1,
              scrollTrigger: {
                trigger: element,
                start: 'top 85%',
                toggleActions: 'play none none none',
                once: true,
              }
            }
          );
        });
        
        // Animate prose headings and paragraphs
        const proseElements = document.querySelectorAll('.prose h2, .prose h3, .prose p, .prose ul, .prose ol');
        
        proseElements.forEach((element, index) => {
          gsap.fromTo(element,
            {
              opacity: 0,
              y: 20,
            },
            {
              opacity: 1,
              y: 0,
              duration: 0.6,
              ease: 'power2.out',
              delay: index * 0.05,
              scrollTrigger: {
                trigger: element,
                start: 'top 90%',
                toggleActions: 'play none none none',
                once: true,
              }
            }
          );
        });
      }).catch((error) => {
        console.error('Failed to load ScrollTrigger:', error);
      });
    }).catch((error) => {
      console.error('Failed to load GSAP:', error);
    });
  </script>
</BlogLayout>

<style>
  .prose {
    color: var(--color-text-secondary);
  }
  
  .prose h1,
  .prose h2,
  .prose h3,
  .prose h4,
  .prose h5,
  .prose h6 {
    color: var(--color-text-primary) !important;
    font-family: var(--font-heading) !important;
    font-weight: var(--font-weight-semibold) !important;
    margin-top: 2.5rem !important;
    margin-bottom: 1.25rem !important;
  }
  
  .prose h1 {
    font-size: 2.5rem !important;
    margin-top: 2.5rem !important;
  }
  
  .prose h2 {
    font-size: 2rem !important;
    margin-top: 3rem !important;
    margin-bottom: 1.5rem !important;
  }
  
  .prose h3 {
    font-size: 1.5rem !important;
    margin-top: 2.5rem !important;
    margin-bottom: 1.25rem !important;
  }
  
  .prose h4 {
    font-size: 1.25rem !important;
    margin-top: 2rem !important;
    margin-bottom: 1rem !important;
  }
  
  .prose p {
    margin-top: 0 !important;
    margin-bottom: 1.75rem !important;
    line-height: 1.8 !important;
    font-size: 1.125rem !important;
  }
  
  /* Pas d'espacement supplémentaire pour le premier paragraphe après un titre */
  .prose h2 + p,
  .prose h3 + p,
  .prose h4 + p {
    margin-top: 0 !important;
  }
  
  .prose-lg p {
    font-size: 1.125rem;
  }
  
  .prose a {
    color: var(--color-accent);
    text-decoration: none;
  }
  
  .prose a:hover {
    color: var(--color-accent-hover);
    text-decoration: underline;
  }
  
  .prose ul,
  .prose ol {
    margin-top: 1rem !important;
    margin-bottom: 1.5rem !important;
    padding-left: 1.625rem !important;
  }
  
  .prose li {
    margin-bottom: 0.75rem !important;
    line-height: 1.7 !important;
  }
  
  /* Espacement avant les listes */
  .prose p + ul,
  .prose p + ol {
    margin-top: 1.5rem !important;
  }
  
  .prose code {
    background-color: var(--color-bg-secondary);
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    font-size: 0.875em;
  }
  
  .prose pre {
    background-color: var(--color-bg-secondary) !important;
    padding: 1.25rem !important;
    border-radius: 0.5rem !important;
    overflow-x: auto !important;
    margin-top: 1.5rem !important;
    margin-bottom: 1.5rem !important;
  }
  
  .prose pre code {
    background-color: transparent !important;
    padding: 0 !important;
  }
  
  .prose blockquote {
    border-left: 4px solid var(--color-accent) !important;
    padding-left: 1.25rem !important;
    margin-left: 0 !important;
    margin-top: 1.5rem !important;
    margin-bottom: 1.5rem !important;
    font-style: italic !important;
    color: var(--color-text-secondary) !important;
  }
  
  /* Images */
  .prose img {
    margin-top: 2rem !important;
    margin-bottom: 2rem !important;
    border-radius: 0.5rem !important;
    max-width: 100% !important;
    height: auto !important;
    display: block !important;
  }
  
  /* Espacement autour des images */
  .prose p + img,
  .prose img + p {
    margin-top: 2rem !important;
  }
  
  .prose h2 + img,
  .prose h3 + img {
    margin-top: 1.5rem !important;
  }
  
  /* Séparateurs (hr) */
  .prose hr {
    margin-top: 3rem !important;
    margin-bottom: 3rem !important;
    border: none !important;
    border-top: 1px solid var(--color-border-default) !important;
  }
  
  /* Strong et emphasis */
  .prose strong {
    color: var(--color-text-primary) !important;
    font-weight: var(--font-weight-semibold) !important;
  }
  
  .prose em {
    font-style: italic !important;
  }
</style>
