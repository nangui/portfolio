---
import BlogLayout from '@layouts/BlogLayout.astro';
import { getCollection, render, type CollectionEntry } from 'astro:content';
import TableOfContents from '@components/blog/TableOfContents.astro';
import ReadingTime from '@components/blog/ReadingTime.astro';
import SocialShare from '@components/blog/SocialShare.astro';
import BlogNavigation from '@components/blog/BlogNavigation.astro';
import { readFileSync } from 'fs';
import { join } from 'path';
import { isValidLocale, defaultLocale } from '@i18n/config';
import { formatPath } from '@i18n/utils';

export async function getStaticPaths() {
  const blogPosts = await getCollection('blog');
  const locales = ['fr', 'en'];
  
  // Helper function to get slug from entry
  const getSlug = (entry: CollectionEntry<'blog'>) => {
    if (entry.data.slug) return entry.data.slug;
    const filename = entry.id.split('/').pop() || entry.id;
    return filename.replace(/\.(md|mdx)$/, '');
  };
  
  // Sort posts by publication date (newest first)
  const sortedPosts = [...blogPosts].sort((a, b) => {
    return b.data.pubDate.getTime() - a.data.pubDate.getTime();
  });
  
  const paths: Array<{ params: { locale: string; slug: string }; props: any }> = [];
  
  sortedPosts.forEach((post: CollectionEntry<'blog'>, index: number) => {
    const slug = getSlug(post);
    
    // Find previous and next posts
    const previous = index < sortedPosts.length - 1 ? sortedPosts[index + 1] : null;
    const next = index > 0 ? sortedPosts[index - 1] : null;
    
    // Generate paths for each locale
    locales.forEach((locale) => {
      paths.push({
        params: { locale, slug },
        props: { post, previous, next, locale },
      });
    });
  });
  
  return paths;
}

interface Props {
  post: CollectionEntry<'blog'>;
  previous?: CollectionEntry<'blog'> | null;
  next?: CollectionEntry<'blog'> | null;
  locale: string;
}

const { post, previous, next, locale: localeParam } = Astro.props;
const locale = isValidLocale(localeParam || '') ? localeParam as 'fr' | 'en' : defaultLocale;
const { Content } = await render(post);

// Get raw markdown content for reading time calculation
const getSlug = (entry: CollectionEntry<'blog'>) => {
  if (entry.data.slug) return entry.data.slug;
  const filename = entry.id.split('/').pop() || entry.id;
  return filename.replace(/\.(md|mdx)$/, '');
};

let rawContent = '';
try {
  const slug = getSlug(post);
  const filePath = join(process.cwd(), 'src', 'content', 'blog', `${slug}.md`);
  rawContent = readFileSync(filePath, 'utf-8');
  rawContent = rawContent.replace(/^---[\s\S]*?---\n/, '');
} catch (error) {
  console.warn('Could not read markdown file for reading time:', error);
  rawContent = '';
}

// Get current URL for sharing
const getSlugForUrl = (entry: CollectionEntry<'blog'>) => {
  if (entry.data.slug) return entry.data.slug;
  const filename = entry.id.split('/').pop() || entry.id;
  return filename.replace(/\.(md|mdx)$/, '');
};
const postSlug = getSlugForUrl(post);
const postUrl = `${Astro.site || 'https://adonainangui.dev'}${formatPath(`/blog/${postSlug}`, locale)}`;

// Get image URL for Open Graph
const siteUrl = Astro.site || 'https://adonainangui.dev';
const ogImage = post.data.image 
  ? `${siteUrl}${post.data.image.startsWith('/') ? post.data.image : `/${post.data.image}`}`
  : undefined;
---

<BlogLayout 
  title={`${post.data.title} - Blog Adonai Nangui`}
  description={post.data.description}
  ogImage={ogImage}
  locale={locale}
>
  <article class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8 md:py-12">
    <!-- Breadcrumb - Go back link style AstroPaper -->
    <nav class="mb-8" aria-label="Breadcrumb">
      <a 
        href={formatPath('/blog', locale)} 
        class="inline-flex items-center gap-2 text-sm text-secondary hover:text-accent transition-colors group"
      >
        <svg class="w-4 h-4 group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        {locale === 'fr' ? 'Retour au blog' : 'Go back'}
      </a>
    </nav>

    <!-- Header -->
    <header class="mb-8">
      <h1 class="font-heading font-semibold text-3xl sm:text-4xl md:text-5xl mb-6 text-primary leading-tight">
        {post.data.title}
      </h1>
      
      <div class="flex flex-wrap items-center gap-4 text-sm text-secondary mb-4">
        <time datetime={post.data.pubDate.toISOString()} class="flex items-center gap-2">
          <svg class="w-4 h-4 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
          <span>
            {locale === 'fr' ? 'Publi√© le' : 'Published on'} {post.data.pubDate.toLocaleDateString(locale === 'fr' ? 'fr-FR' : 'en-US', { 
              year: 'numeric', 
              month: 'long', 
              day: 'numeric' 
            })}
          </span>
        </time>
        
        {rawContent && <ReadingTime content={rawContent} locale={locale} />}
      </div>
      
      {post.data.tags && post.data.tags.length > 0 && (
        <div class="flex flex-wrap items-center gap-2">
          <svg class="w-4 h-4 text-secondary/60 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
          </svg>
          {post.data.tags.map((tag: string) => (
            <span class="px-3 py-1 bg-secondary/50 border border-border-default rounded-full text-xs hover:bg-secondary transition-colors whitespace-nowrap">
              {tag}
            </span>
          ))}
        </div>
      )}
    </header>

    <hr class="border-border-default mb-8" />
    
    <!-- Table of Contents - Collapsible at top -->
    <TableOfContents locale={locale} />
    
    <!-- Main Content -->
    <div class="prose prose-invert prose-lg max-w-none text-secondary">
      <Content />
    </div>
    
    <!-- Code block enhancements script -->
    <script is:inline>
      (function() {
        const enhanceCodeBlocks = () => {
          const codeBlocks = document.querySelectorAll('pre.astro-code');
          
          codeBlocks.forEach((block) => {
            // Force padding for line numbers visibility - override inline styles
            block.style.setProperty('padding-left', '3.5rem', 'important');
            
            // Wrap in container if not already wrapped
            let wrapper = block.parentElement;
            if (!wrapper?.classList.contains('code-block-wrapper')) {
              wrapper = document.createElement('div');
              wrapper.className = 'code-block-wrapper relative group';
              block.parentNode?.insertBefore(wrapper, block);
              wrapper.appendChild(block);
            }
            
            // Add copy button if it doesn't exist
            if (!wrapper.querySelector('.copy-code-btn')) {
              const copyBtn = document.createElement('button');
              copyBtn.className = 'copy-code-btn absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity p-2 rounded-md bg-secondary/80 hover:bg-secondary border border-border-default hover:border-accent text-secondary hover:text-accent z-10';
              copyBtn.setAttribute('aria-label', 'Copy code');
              copyBtn.setAttribute('title', 'Copy code');
              copyBtn.innerHTML = `
                <svg class="copy-icon w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                </svg>
                <svg class="check-icon w-4 h-4 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
              `;
              
              copyBtn.addEventListener('click', async () => {
                const code = block.querySelector('code');
                if (!code) return;
                
                const text = code.textContent || '';
                
                try {
                  await navigator.clipboard.writeText(text);
                  
                  // Show check icon
                  const copyIcon = copyBtn.querySelector('.copy-icon');
                  const checkIcon = copyBtn.querySelector('.check-icon');
                  if (copyIcon && checkIcon) {
                    copyIcon.classList.add('hidden');
                    checkIcon.classList.remove('hidden');
                  }
                  
                  // Reset after 2 seconds
                  setTimeout(() => {
                    if (copyIcon && checkIcon) {
                      copyIcon.classList.remove('hidden');
                      checkIcon.classList.add('hidden');
                    }
                  }, 2000);
                } catch (err) {
                  console.error('Failed to copy code:', err);
                }
              });
              
              wrapper.appendChild(copyBtn);
            }
          });
        };
        
        // Run on load
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', enhanceCodeBlocks);
        } else {
          enhanceCodeBlocks();
        }
        
        // Run on Astro page transitions
        document.addEventListener('astro:page-load', enhanceCodeBlocks);
      })();
    </script>
    
    <hr class="border-border-default mt-12 mb-8" />
    
    <!-- Social Share -->
    <SocialShare 
      title={post.data.title}
      url={postUrl}
      description={post.data.description}
      locale={locale}
    />
    
    <!-- Blog Navigation -->
    <BlogNavigation 
      previous={previous} 
      next={next} 
      locale={locale}
    />
  </article>
</BlogLayout>

<style>
  /* Prose base styles */
  .prose {
    color: var(--color-text-secondary);
    line-height: 1.75;
  }
  
  /* Headings */
  .prose h1,
  .prose h2,
  .prose h3,
  .prose h4,
  .prose h5,
  .prose h6 {
    color: var(--color-text-primary) !important;
    font-family: var(--font-heading) !important;
    font-weight: 600 !important;
    line-height: 1.3 !important;
    scroll-margin-top: 6rem;
  }
  
  .prose h2 {
    font-size: 1.875rem !important;
    margin-top: 3rem !important;
    margin-bottom: 1.25rem !important;
  }
  
  .prose h3 {
    font-size: 1.5rem !important;
    margin-top: 2.5rem !important;
    margin-bottom: 1rem !important;
  }
  
  .prose h4 {
    font-size: 1.25rem !important;
    margin-top: 2rem !important;
    margin-bottom: 0.875rem !important;
  }
  
  /* Paragraphs */
  .prose p {
    margin-top: 0 !important;
    margin-bottom: 1.5rem !important;
    font-size: 1.0625rem !important;
    line-height: 1.75 !important;
  }
  
  .prose h2 + p,
  .prose h3 + p,
  .prose h4 + p {
    margin-top: 0 !important;
  }
  
  /* Links */
  .prose a {
    color: var(--color-accent);
    text-decoration: underline;
    text-underline-offset: 2px;
  }
  
  .prose a:hover {
    text-decoration-thickness: 2px;
  }
  
  /* Lists */
  .prose ul,
  .prose ol {
    margin-top: 1.25rem !important;
    margin-bottom: 1.5rem !important;
    padding-left: 1.75rem !important;
  }
  
  .prose li {
    margin-bottom: 0.5rem !important;
    line-height: 1.75 !important;
  }
  
  .prose li::marker {
    color: var(--color-accent);
  }
  
  /* Code */
  .prose code {
    background-color: var(--color-bg-secondary);
    color: var(--color-accent);
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    font-size: 0.875em;
    font-family: 'Monaco', 'Courier New', monospace;
  }
  
  /* Code blocks - only apply to non-Astro code blocks */
  .prose pre:not(.astro-code) {
    background-color: var(--color-bg-secondary) !important;
    padding: 1.5rem !important;
    border-radius: 0.5rem !important;
    overflow-x: auto !important;
    margin-top: 2rem !important;
    margin-bottom: 2rem !important;
    border: 1px solid var(--color-border-default) !important;
  }
  
  .prose pre:not(.astro-code) code {
    background-color: transparent !important;
    color: var(--color-text-secondary) !important;
    padding: 0 !important;
    font-size: 0.875rem !important;
  }
  
  /* Astro code blocks - use Shiki CSS variables */
  .prose pre.astro-code {
    margin-top: 2rem !important;
    margin-bottom: 2rem !important;
  }
  
  :root[data-theme="light"] .prose pre.astro-code {
    background-color: var(--shiki-light-bg) !important;
    border: 1px solid #d0d7de !important;
  }
  
  :root[data-theme="dark"] .prose pre.astro-code {
    background-color: var(--shiki-dark-bg) !important;
    border: 1px solid var(--color-border-default) !important;
  }
  
  /* Code block wrapper for copy button */
  .code-block-wrapper {
    position: relative;
  }
  
  .code-block-wrapper pre.astro-code {
    padding-left: 3.5rem !important;
  }
  
  .copy-code-btn {
    cursor: pointer;
  }
  
  .copy-code-btn:focus {
    outline: 2px solid var(--color-accent);
    outline-offset: 2px;
  }
  
  /* Blockquotes */
  .prose blockquote {
    border-left: 3px solid var(--color-accent) !important;
    padding-left: 1.25rem !important;
    margin-left: 0 !important;
    margin-top: 2rem !important;
    margin-bottom: 2rem !important;
    font-style: italic !important;
    color: var(--color-text-secondary) !important;
    opacity: 0.9;
  }
  
  .prose blockquote p {
    margin-bottom: 0.75rem !important;
  }
  
  /* Images */
  .prose img {
    margin-top: 2rem !important;
    margin-bottom: 2rem !important;
    border-radius: 0.5rem !important;
    max-width: 100% !important;
    height: auto !important;
    display: block !important;
    border: 1px solid var(--color-border-default);
  }
  
  /* Horizontal rule */
  .prose hr {
    margin-top: 3rem !important;
    margin-bottom: 3rem !important;
    border: none !important;
    border-top: 1px solid var(--color-border-default) !important;
  }
  
  /* Strong and emphasis */
  .prose strong {
    color: var(--color-text-primary) !important;
    font-weight: 600 !important;
  }
  
  .prose em {
    font-style: italic !important;
  }
  
  /* Tables */
  .prose table {
    width: 100%;
    margin-top: 2rem !important;
    margin-bottom: 2rem !important;
    border-collapse: collapse;
  }
  
  .prose th,
  .prose td {
    border: 1px solid var(--color-border-default);
    padding: 0.75rem 1rem;
    text-align: left;
  }
  
  .prose th {
    background-color: var(--color-bg-secondary);
    font-weight: 600;
    color: var(--color-text-primary);
  }
  
  /* Responsive */
  @media (max-width: 640px) {
    .prose h2 {
      font-size: 1.5rem !important;
    }
    
    .prose h3 {
      font-size: 1.25rem !important;
    }
    
    .prose p {
      font-size: 1rem !important;
    }
  }
</style>
