---
import { locales, localeLabels, localeCodes, type Locale } from '@i18n/config';
import { formatPath } from '@i18n/utils';

interface Props {
  currentLocale: Locale;
  currentPath: string;
}

const { currentLocale, currentPath } = Astro.props;

// Get the path without locale for switching
const pathWithoutLocale = currentPath.replace(/^\/(fr|en)/, '') || '/';
---

<div class="language-switcher relative" data-language-switcher>
  <button
    class="lang-toggle-button group flex items-center gap-2 px-3 py-2 bg-secondary/80 backdrop-blur-sm border border-border-default rounded-lg hover:border-accent hover:bg-secondary transition-all duration-300 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-accent"
    aria-label="Changer la langue"
    aria-expanded="false"
    aria-haspopup="true"
    data-lang-toggle
  >
    <svg class="w-4 h-4 text-secondary group-hover:text-accent transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"></path>
    </svg>
    <span class="text-sm font-medium text-secondary group-hover:text-accent transition-colors" data-current-locale>
      {localeCodes[currentLocale]}
    </span>
    <svg class="w-3 h-3 text-secondary group-hover:text-accent transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
    </svg>
  </button>
  
  <div 
    class="lang-menu hidden absolute top-full mt-2 right-0 bg-secondary border border-border-default rounded-lg shadow-lg overflow-hidden min-w-[140px] z-50"
    data-lang-menu
    role="menu"
  >
    {locales.map((locale: Locale) => (
      <a
        href={formatPath(pathWithoutLocale, locale)}
        class={`lang-option w-full text-left px-4 py-2.5 text-sm transition-colors hover:bg-tertiary hover:text-accent flex items-center justify-between ${
          locale === currentLocale 
            ? 'bg-accent/10 text-accent font-medium' 
            : 'text-secondary'
        }`}
        data-locale={locale}
        role="menuitem"
        aria-label={`Changer en ${localeLabels[locale]}`}
        hreflang={locale}
      >
        <span class="font-medium">{localeCodes[locale]}</span>
        <span class="text-xs opacity-70 ml-2">{localeLabels[locale]}</span>
      </a>
    ))}
  </div>
</div>

<script>
  const initLanguageSwitcher = () => {
    const switcher = document.querySelector('[data-language-switcher]');
    if (!switcher) return;

    const toggleButton = switcher.querySelector('[data-lang-toggle]') as HTMLElement;
    const langMenu = switcher.querySelector('[data-lang-menu]') as HTMLElement;

    if (!toggleButton || !langMenu) return;

    // Toggle menu
    toggleButton.addEventListener('click', (e) => {
      e.stopPropagation();
      const isHidden = langMenu.classList.contains('hidden');
      langMenu.classList.toggle('hidden');
      toggleButton.setAttribute('aria-expanded', isHidden ? 'true' : 'false');
    });

    // Close menu when clicking outside
    document.addEventListener('click', (e) => {
      if (langMenu && toggleButton && 
          !langMenu.contains(e.target as Node) && 
          !toggleButton.contains(e.target as Node)) {
        langMenu.classList.add('hidden');
        toggleButton.setAttribute('aria-expanded', 'false');
      }
    });

    // Close menu with Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !langMenu.classList.contains('hidden')) {
        langMenu.classList.add('hidden');
        toggleButton.setAttribute('aria-expanded', 'false');
        toggleButton.focus();
      }
    });
  };

  // Initialize on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initLanguageSwitcher);
  } else {
    initLanguageSwitcher();
  }

  // Reinitialize on page transitions (Astro)
  document.addEventListener('astro:page-load', initLanguageSwitcher);
</script>

<style>
  .language-switcher {
    pointer-events: none;
  }

  .language-switcher > * {
    pointer-events: auto;
  }

  .lang-menu {
    animation: fadeIn 0.2s ease-out;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(-8px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>
