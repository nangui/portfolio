---
// Table of Contents component that generates TOC from rendered content
---

<nav class="toc-container mb-8 p-6 bg-secondary/30 border border-border-default rounded-lg sticky top-8 hidden" id="toc-nav" aria-label="Table des matières">
  <h2 class="text-lg font-heading font-semibold text-primary mb-4 flex items-center gap-2">
    <svg class="w-5 h-5 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
    </svg>
    Table des matières
  </h2>
  <ol class="space-y-2 text-sm" id="toc-list">
    <!-- TOC items will be generated by JavaScript -->
  </ol>
</nav>

<script>
  // Generate TOC from headings in the content
  if (typeof document !== 'undefined') {
    const generateTOC = () => {
      const headings = document.querySelectorAll('.prose h2, .prose h3');
      const tocNav = document.getElementById('toc-nav');
      const tocList = document.getElementById('toc-list');
      
      if (!tocNav || !tocList || headings.length < 2) {
        return; // Hide TOC if not enough headings
      }
      
      // Show TOC
      tocNav.classList.remove('hidden');
      
      // Clear existing TOC
      tocList.innerHTML = '';
      
      // Generate TOC items
      headings.forEach((heading) => {
        const text = heading.textContent || '';
        const id = text
          .toLowerCase()
          .replace(/[^\w\s-]/g, '')
          .replace(/\s+/g, '-')
          .replace(/-+/g, '-')
          .trim();
        
        // Set heading ID
        heading.id = id;
        const htmlHeading = heading as HTMLElement;
        if (htmlHeading.style) {
          htmlHeading.style.scrollMarginTop = '2rem';
        }
        
        // Create TOC item
        const li = document.createElement('li');
        li.className = heading.tagName === 'H3' ? 'ml-4' : '';
        
        const a = document.createElement('a');
        a.href = `#${id}`;
        a.className = 'text-secondary hover:text-accent transition-colors block py-1';
        a.setAttribute('data-toc-link', '');
        a.textContent = text;
        
        li.appendChild(a);
        tocList.appendChild(li);
      });
      
      // Highlight active TOC link on scroll
      const tocLinks = document.querySelectorAll('[data-toc-link]');
      const observerOptions = {
        rootMargin: '-20% 0px -70% 0px',
        threshold: 0,
      };
      
      const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
          const id = entry.target.id;
          const tocLink = document.querySelector(`[data-toc-link][href="#${id}"]`);
          
          if (entry.isIntersecting) {
            tocLinks.forEach((link) => link.classList.remove('text-accent', 'font-medium'));
            if (tocLink) {
              tocLink.classList.add('text-accent', 'font-medium');
            }
          }
        });
      }, observerOptions);
      
      headings.forEach((heading) => observer.observe(heading));
    };
    
    // Wait for content to be rendered
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', generateTOC);
    } else {
      // Use setTimeout to ensure content is rendered
      setTimeout(generateTOC, 100);
    }
  }
</script>

<style>
  .toc-container {
    max-height: calc(100vh - 4rem);
    overflow-y: auto;
  }
  
  .toc-container::-webkit-scrollbar {
    width: 6px;
  }
  
  .toc-container::-webkit-scrollbar-track {
    background: transparent;
  }
  
  .toc-container::-webkit-scrollbar-thumb {
    background: var(--color-border-default);
    border-radius: 3px;
  }
  
  .toc-container::-webkit-scrollbar-thumb:hover {
    background: var(--color-border-light);
  }
  
  [data-toc-link] {
    scroll-behavior: smooth;
  }
</style>
