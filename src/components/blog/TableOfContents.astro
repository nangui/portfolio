---
import { defaultLocale, type Locale } from '@i18n/config';

interface Props {
  locale?: Locale;
}

const { locale = defaultLocale } = Astro.props;
const tocTitle = locale === 'fr' ? 'Table des mati√®res' : 'Table of contents';
const openLabel = locale === 'fr' ? 'Ouvrir' : 'Open';
---

<details class="toc-details mb-8 bg-secondary/30 border border-border-default rounded-lg overflow-hidden hidden" id="toc-details" open>
  <summary class="cursor-pointer px-4 py-3 hover:bg-secondary/50 transition-colors flex items-center justify-between gap-3 select-none">
    <span class="font-heading font-semibold text-primary flex items-center gap-2">
      <svg class="w-5 h-5 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
      </svg>
      {tocTitle}
    </span>
    <svg class="w-5 h-5 text-secondary transition-transform toc-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
    </svg>
  </summary>
  <nav class="px-4 pb-4" aria-label={tocTitle}>
    <ol class="space-y-2 text-sm" id="toc-list">
      <!-- TOC items will be generated by JavaScript -->
    </ol>
  </nav>
</details>

<script>
  // Generate TOC from headings in the content
  if (typeof document !== 'undefined') {
    const generateTOC = () => {
      const headings = document.querySelectorAll('.prose h2, .prose h3');
      const tocDetails = document.getElementById('toc-details');
      const tocList = document.getElementById('toc-list');
      
      if (!tocDetails || !tocList || headings.length < 2) {
        return; // Hide TOC if not enough headings
      }
      
      // Show TOC
      tocDetails.classList.remove('hidden');
      
      // Clear existing TOC
      tocList.innerHTML = '';
      
      // Generate TOC items
      headings.forEach((heading) => {
        const text = heading.textContent || '';
        const id = text
          .toLowerCase()
          .replace(/[^\w\s-]/g, '')
          .replace(/\s+/g, '-')
          .replace(/-+/g, '-')
          .trim();
        
        // Set heading ID
        heading.id = id;
        const htmlHeading = heading as HTMLElement;
        if (htmlHeading.style) {
          htmlHeading.style.scrollMarginTop = '6rem';
        }
        
        // Create TOC item
        const li = document.createElement('li');
        li.className = heading.tagName === 'H3' ? 'ml-4' : '';
        
        const a = document.createElement('a');
        a.href = `#${id}`;
        a.className = 'text-secondary hover:text-accent transition-colors block py-1.5 hover:underline';
        a.setAttribute('data-toc-link', '');
        a.textContent = text;
        
        // Close TOC on mobile when clicking a link
        a.addEventListener('click', () => {
          if (window.innerWidth < 768) {
            const details = a.closest('details');
            if (details) {
              details.removeAttribute('open');
            }
          }
        });
        
        li.appendChild(a);
        tocList.appendChild(li);
      });
      
      // Highlight active TOC link on scroll
      const tocLinks = document.querySelectorAll('[data-toc-link]');
      const observerOptions = {
        rootMargin: '-80px 0px -70% 0px',
        threshold: 0,
      };
      
      const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
          const id = entry.target.id;
          const tocLink = document.querySelector(`[data-toc-link][href="#${id}"]`);
          
          if (entry.isIntersecting) {
            tocLinks.forEach((link) => link.classList.remove('text-accent', 'font-medium'));
            if (tocLink) {
              tocLink.classList.add('text-accent', 'font-medium');
            }
          }
        });
      }, observerOptions);
      
      headings.forEach((heading) => observer.observe(heading));
    };
    
    // Rotate chevron on details toggle
    const rotateChevron = () => {
      const details = document.getElementById('toc-details');
      if (details) {
        details.addEventListener('toggle', () => {
          const chevron = details.querySelector('.toc-chevron');
          if (chevron) {
            if (details.open) {
              chevron.style.transform = 'rotate(0deg)';
            } else {
              chevron.style.transform = 'rotate(-90deg)';
            }
          }
        });
      }
    };
    
    // Wait for content to be rendered
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        generateTOC();
        rotateChevron();
      });
    } else {
      // Use setTimeout to ensure content is rendered
      setTimeout(() => {
        generateTOC();
        rotateChevron();
      }, 100);
    }
  }
</script>

<style>
  .toc-details summary {
    list-style: none;
  }
  
  .toc-details summary::-webkit-details-marker {
    display: none;
  }
  
  .toc-chevron {
    transition: transform 0.2s ease;
  }
  
  .toc-details[open] .toc-chevron {
    transform: rotate(0deg);
  }
  
  .toc-details:not([open]) .toc-chevron {
    transform: rotate(-90deg);
  }
  
  [data-toc-link] {
    scroll-behavior: smooth;
  }
  
  /* Smooth scroll offset */
  html {
    scroll-padding-top: 6rem;
  }
</style>
