---
import { defaultLocale, type Locale } from '@i18n/config';
import { getTranslation } from '@i18n/translations';

interface Props {
  locale?: Locale;
}

const { locale = defaultLocale } = Astro.props;

// Experience data structure with translation keys
const experiences = [
  {
    key: 'masskode',
    company: 'MassKode',
    impactCount: 5,
  },
  {
    key: 'djoubo',
    company: 'Djoubo',
    impactCount: 5,
  },
  {
    key: 'gebeya-senior',
    company: 'Gebeya Inc',
    impactCount: 4,
  },
  {
    key: 'socium',
    company: 'Socium',
    impactCount: 4,
  },
  {
    key: 'sonatel',
    company: 'Sonatel',
    impactCount: 4,
  },
  {
    key: 'gebeya-fullstack',
    company: 'Gebeya Inc',
    impactCount: 4,
  },
];

// Helper function to get experience data
const getExperienceData = (exp: typeof experiences[0], locale: Locale) => {
  const role = getTranslation('experience', `${exp.key}.role`, locale);
  const period = getTranslation('experience', `${exp.key}.period`, locale);
  const impacts: string[] = [];
  
  for (let i = 1; i <= exp.impactCount; i++) {
    const impact = getTranslation('experience', `${exp.key}.impact${i}`, locale);
    if (impact && impact !== `${exp.key}.impact${i}`) {
      impacts.push(impact);
    }
  }
  
  return {
    role,
    company: exp.company,
    period,
    impacts,
  };
};
---

<section id="experience" class="py-24 bg-secondary overflow-hidden">
  <div class="max-w-[1400px] mx-auto px-4 sm:px-6 lg:px-8">
    <h2 class="font-heading font-semibold text-3xl md:text-4xl mb-12 text-primary">
      {getTranslation('experience', 'heading', locale)}
    </h2>
    
    <!-- Horizontal scrollable timeline -->
    <div class="relative">
      <!-- Timeline container -->
      <div class="overflow-x-auto pb-8 scrollbar-custom" data-experience-scroll>
        <div class="flex gap-8 min-w-max pr-8">
        {experiences.map((exp, index) => {
          const expData = getExperienceData(exp, locale);
          return (
            <article 
              class="experience-card group relative shrink-0 w-[380px] bg-bg-secondary border border-border-default rounded-lg p-8 hover:border-accent transition-all duration-300"
              data-experience-index={index}
              style="position: relative; z-index: 1;"
              aria-labelledby={`experience-role-${index}`}
            >
              <!-- Card number indicator - z-index corrigé -->
              <div class="absolute -top-4 -left-4 w-12 h-12 bg-accent rounded-full flex items-center justify-center font-heading font-bold text-lg text-bg-primary shadow-lg" style="z-index: 20; position: relative;">
                {index + 1}
              </div>
            
              <!-- Period badge -->
              <div class="inline-flex items-center gap-2 px-3 py-1.5 bg-accent/10 border border-accent/20 rounded-full mb-6">
                <svg class="w-4 h-4 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                <span class="text-accent text-sm font-medium">{expData.period}</span>
              </div>

              <!-- Role and company -->
              <div class="mb-6">
                <h3 id={`experience-role-${index}`} class="font-heading font-semibold text-xl text-primary mb-2 group-hover:text-accent transition-colors">
                    {expData.role}
                  </h3>
                <p class="font-medium text-lg text-secondary" aria-label={`Entreprise: ${expData.company}`}>
                    {expData.company}
                  </p>
              </div>
              
              <!-- Impacts list -->
              <ul class="space-y-3" role="list" aria-label="Réalisations et impacts">
                {expData.impacts.map((impact) => (
                  <li class="flex items-start gap-3 text-secondary" role="listitem">
                    <svg class="w-5 h-5 text-accent shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <span class="text-sm leading-relaxed">{impact}</span>
                  </li>
                ))}
              </ul>

              <!-- Decorative corner -->
              <div class="absolute bottom-0 right-0 w-24 h-24 opacity-5 group-hover:opacity-10 transition-opacity pointer-events-none" aria-hidden="true">
                <svg viewBox="0 0 100 100" fill="currentColor" class="text-accent" aria-hidden="true">
                  <circle cx="100" cy="100" r="100" />
                </svg>
              </div>
            </article>
          );
        })}
      </div>
    </div>

      <!-- Progress indicator -->
      <div class="mt-4 h-1 bg-bg-tertiary rounded-full overflow-hidden">
        <div class="h-full bg-accent transition-all duration-300" id="experience-progress" style="width: 0%"></div>
      </div>
    </div>
  </div>
</section>

<script>
  import { gsap } from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';

      gsap.registerPlugin(ScrollTrigger);
      
  // Pause/resume animations based on page visibility
  let visibilityHandler: (() => void) | null = null;

  const setupVisibilityHandler = () => {
    if (visibilityHandler) return; // Already set up

    visibilityHandler = () => {
      if (document.hidden) {
        gsap.globalTimeline.pause();
        ScrollTrigger.getAll().forEach(trigger => trigger.disable());
      } else {
        gsap.globalTimeline.resume();
        ScrollTrigger.getAll().forEach(trigger => trigger.enable());
      }
    };

    if (typeof document !== 'undefined') {
      document.addEventListener('visibilitychange', visibilityHandler);
    }
  };

  setupVisibilityHandler();

  const initExperience = () => {
    const scrollContainer = document.querySelector('[data-experience-scroll]') as HTMLElement;
    const cards = document.querySelectorAll('.experience-card');
    const progressBar = document.getElementById('experience-progress');

    if (!scrollContainer || !progressBar) return;

    // Animate cards on scroll into view
    cards.forEach((card, index) => {
      gsap.fromTo(
        card,
          {
            opacity: 0,
          y: 50,
          scale: 0.95,
          },
          {
            opacity: 1,
          y: 0,
          scale: 1,
          duration: 0.6,
            ease: 'power2.out',
            scrollTrigger: {
            trigger: card,
              start: 'top 85%',
              toggleActions: 'play none none reverse',
          },
          delay: index * 0.1,
          }
        );
      });

    // Update progress bar based on horizontal scroll
    const updateProgress = () => {
      const scrollLeft = scrollContainer.scrollLeft;
      const scrollWidth = scrollContainer.scrollWidth - scrollContainer.clientWidth;
      const progress = (scrollLeft / scrollWidth) * 100;
      progressBar.style.width = `${Math.min(progress, 100)}%`;
    };

    scrollContainer.addEventListener('scroll', updateProgress);
    updateProgress();

    // Parallax effect on cards
    scrollContainer.addEventListener('scroll', () => {
      cards.forEach((card) => {
        const rect = card.getBoundingClientRect();
        const containerRect = scrollContainer.getBoundingClientRect();
        const offset = rect.left - containerRect.left;
        const parallaxAmount = (offset / containerRect.width) * 20;
        
        gsap.to(card, {
          y: parallaxAmount,
          duration: 0.3,
          ease: 'power1.out',
        });
      });
    });

    // Cleanup
    return () => {
      scrollContainer.removeEventListener('scroll', updateProgress);
    };
  };

  // Initialize
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initExperience);
  } else {
    initExperience();
  }

  // Reinitialize on page transitions
  document.addEventListener('astro:page-load', initExperience);
</script>

<style>
  /* Hide scrollbar but keep scrolling functionality */
  .scrollbar-custom {
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none; /* IE and Edge */
  }

  .scrollbar-custom::-webkit-scrollbar {
    display: none; /* Chrome, Safari, Opera */
  }

  /* Smooth scrolling */
  [data-experience-scroll] {
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
  }

  /* Card hover effects */
  .experience-card {
    transform-origin: center center;
    will-change: transform;
  }

  @media (max-width: 768px) {
    .experience-card {
      width: 320px;
    }
  }
</style>
