---
import { getCollection, type CollectionEntry } from 'astro:content';
import Button from '@components/ui/Button.astro';
import ProjectCardHover from '@components/ui/ProjectCardHover.astro';
import { defaultLocale, type Locale } from '@i18n/config';
import { getTranslation } from '@i18n/translations';
import { formatPath } from '@i18n/utils';

interface Props {
  locale?: Locale;
}

const { locale = defaultLocale } = Astro.props;

const allProjects = await getCollection('projects').catch(() => []) as CollectionEntry<'projects'>[];

// Helper function to get slug from entry (needed for deduplication)
const getSlugForDedup = (entry: CollectionEntry<'projects'>): string => {
  if (entry.data.slug) {
    return entry.data.slug.replace(/-(fr|en)$/, '');
  }
  const filename = entry.id.split('/').pop() || entry.id;
  return filename.replace(/\.(fr|en)\.(md|mdx)$/, '').replace(/\.(md|mdx)$/, '');
};

// Deduplicate projects by slug (keep only one version per project)
// Prefer the version matching the current locale, otherwise use the first one
const getLocaleFromId = (id: string): string | null => {
  const filename = id.split('/').pop() || id;
  if (/\.fr\.(md|mdx)$/.test(filename)) return 'fr';
  if (/\.en\.(md|mdx)$/.test(filename)) return 'en';
  return null;
};

const projectsBySlug = new Map<string, CollectionEntry<'projects'>>();
allProjects.forEach((project: CollectionEntry<'projects'>) => {
  const slug = getSlugForDedup(project);
  if (!projectsBySlug.has(slug)) {
    projectsBySlug.set(slug, project);
  } else {
    // If we already have a project with this slug, prefer the one matching current locale
    const existing = projectsBySlug.get(slug)!;
    const existingLocale = getLocaleFromId(existing.id);
    const currentLocale = getLocaleFromId(project.id);
    
    // Replace if current project matches locale better
    if (currentLocale === locale && existingLocale !== locale) {
      projectsBySlug.set(slug, project);
    }
  }
});

const featuredProjects = Array.from(projectsBySlug.values())
  .filter((project: CollectionEntry<'projects'>) => project.data.featured !== false)
  .slice(0, 6)
  // Sort by priority if necessary (currently no sorting needed)

// Helper function to get slug from entry
// With glob loader, id contains the file path relative to base
const getSlug = (entry: CollectionEntry<'projects'>): string => {
  if (entry.data.slug) {
    // Normalize slug: remove locale suffix if present (e.g., "socium-fr" -> "socium")
    return entry.data.slug.replace(/-(fr|en)$/, '');
  }
  // Extract filename from id and remove extension
  const filename = entry.id.split('/').pop() || entry.id;
  // Remove locale suffix if present (e.g., djoubo.en.md -> djoubo)
  return filename.replace(/\.(fr|en)\.(md|mdx)$/, '').replace(/\.(md|mdx)$/, '');
};

// Helper function to get image for hover effect
const getHoverImage = (project: CollectionEntry<'projects'>): string | undefined => {
  if (project.data.images && project.data.images.length > 0) {
    return project.data.images[0];
  }
  return project.data.image;
};
---

<section id="projects" class="py-section bg-primary">
  <div class="max-w-[1200px] mx-auto px-4 sm:px-6 lg:px-8">
    <h2 class="font-heading font-semibold text-3xl md:text-4xl mb-12 text-primary">
      {getTranslation('projects', 'heading', locale)}
    </h2>
    
    {featuredProjects.length > 0 ? (
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        {featuredProjects.map((project: CollectionEntry<'projects'>) => (
            <article 
              class="project-card bg-secondary border border-border-default rounded-lg p-6 hover:border-border-light transition-colors cursor-pointer"
              aria-labelledby={`project-title-${getSlug(project)}`}
              data-project-image={getHoverImage(project)}
              data-project-slug={getSlug(project)}
            >
              <h3 id={`project-title-${getSlug(project)}`} class="font-heading font-semibold text-xl mb-2 text-primary">
                {locale === 'fr' 
                  ? (project.data.title_fr || project.data.title || '')
                  : (project.data.title_en || project.data.title || '')}
              </h3>
              <p class="text-secondary mb-4 line-clamp-3">
                {locale === 'fr'
                  ? (project.data.description_fr || project.data.description || '')
                  : (project.data.description_en || project.data.description || '')}
              </p>
              <div class="flex flex-wrap gap-2 mb-4" role="list" aria-label="Technologies utilisÃ©es">
                {project.data.stack.slice(0, 3).map((tech: string) => (
                  <span class="px-2 py-1 bg-bg-tertiary text-xs text-secondary rounded" role="listitem">
                    {tech}
                  </span>
                ))}
              </div>
              <Button 
                href={formatPath(`/projects/${getSlug(project)}`, locale)} 
                variant="ghost" 
                size="sm"
                ariaLabel={`${getTranslation('projects', 'learnMore', locale)} ${locale === 'fr' 
                  ? (project.data.title_fr || project.data.title || '')
                  : (project.data.title_en || project.data.title || '')}`}
              >
                {getTranslation('projects', 'learnMore', locale)}
              </Button>
            </article>
          ))}
      </div>
    ) : (
      <p class="text-secondary text-center py-12">
        {getTranslation('projects', 'noProjects', locale)}
      </p>
    )}
  </div>
  
  <!-- WebGL Canvas for hover effects -->
  <ProjectCardHover />
</section>
