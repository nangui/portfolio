---
import { getCollection, type CollectionEntry } from 'astro:content';
import Button from '@components/ui/Button.astro';
import ProjectCardHover from '@components/ui/ProjectCardHover.astro';
import { defaultLocale, type Locale } from '@i18n/config';
import { getTranslation } from '@i18n/translations';
import { formatPath } from '@i18n/utils';

interface Props {
  locale?: Locale;
}

const { locale = defaultLocale } = Astro.props;

const allProjects = await getCollection('projects').catch(() => []) as CollectionEntry<'projects'>[];
const featuredProjects = allProjects
  .filter((project: CollectionEntry<'projects'>) => project.data.featured !== false)
  .slice(0, 6)
  // Sort by priority if necessary (currently no sorting needed)

// Helper function to get slug from entry
// With glob loader, id contains the file path relative to base
const getSlug = (entry: CollectionEntry<'projects'>): string => {
  if (entry.data.slug) return entry.data.slug;
  // Extract filename from id and remove extension
  const filename = entry.id.split('/').pop() || entry.id;
  return filename.replace(/\.(md|mdx)$/, '');
};
---

<section id="projects" class="py-section bg-primary">
  <div class="max-w-[1200px] mx-auto px-4 sm:px-6 lg:px-8">
    <h2 class="font-heading font-semibold text-3xl md:text-4xl mb-12 text-primary">
      {getTranslation('projects', 'heading', locale)}
    </h2>
    
    {featuredProjects.length > 0 ? (
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        {featuredProjects.map((project: CollectionEntry<'projects'>) => (
            <article 
              class="project-card bg-secondary border border-border-default rounded-lg p-6 hover:border-border-light transition-colors cursor-pointer"
              aria-labelledby={`project-title-${getSlug(project)}`}
              data-project-image={project.data.image}
              data-project-slug={getSlug(project)}
            >
              <h3 id={`project-title-${getSlug(project)}`} class="font-heading font-semibold text-xl mb-2 text-primary">
                {project.data.title}
              </h3>
              <p class="text-secondary mb-4 line-clamp-3">
                {project.data.description}
              </p>
              <div class="flex flex-wrap gap-2 mb-4" role="list" aria-label="Technologies utilisÃ©es">
                {project.data.stack.slice(0, 3).map((tech: string) => (
                  <span class="px-2 py-1 bg-bg-tertiary text-xs text-secondary rounded" role="listitem">
                    {tech}
                  </span>
                ))}
              </div>
              <Button 
                href={formatPath(`/projects/${getSlug(project)}`, locale)} 
                variant="ghost" 
                size="sm"
                ariaLabel={`${getTranslation('projects', 'learnMore', locale)} ${project.data.title}`}
              >
                {getTranslation('projects', 'learnMore', locale)}
              </Button>
            </article>
          ))}
      </div>
    ) : (
      <p class="text-secondary text-center py-12">
        {getTranslation('projects', 'noProjects', locale)}
      </p>
    )}
  </div>
  
  <!-- WebGL Canvas for hover effects -->
  <ProjectCardHover />
</section>
